{% extends "base.html" %}

{% block title %}Analytics | ReflectAI{% endblock %}

{% block content %}
<div class="card-custom fade-in">
Â  Â  <h2 class="mb-4">ðŸ“Š Your Emotional Journey</h2>
Â  Â  
Â  Â  <div id="loadingSpinner" class="text-center my-5">
Â  Â  Â  Â  <div class="spinner-border" role="status"></div>
Â  Â  Â  Â  <p class="mt-2">Loading analytics...</p>
Â  Â  </div>
Â  Â  
Â  Â  <div id="analyticsContent" style="display: none;">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="row mb-4">
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value" id="metricTotal">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Total Entries</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value" id="metricAvg">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Avg Sentiment</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value" id="metricPositive">0%</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Positive Days</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-md-3">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-value" id="metricSpan">0</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="metric-label">Days Tracked</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <hr class="my-4">
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  Â  <div class="col-lg-8">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="mb-3">Sentiment Over Time</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="sentimentChart" style="max-height: 300px;"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="col-lg-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="mb-3">Emotion Distribution</h4>
Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="emotionChart" style="max-height: 300px;"></canvas>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <hr class="my-4">
Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="mb-3">ðŸ“‹ Recent Entries</h4>
Â  Â  Â  Â  <div class="table-responsive">
Â  Â  Â  Â  Â  Â  <table class="table table-dark table-hover">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Date</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Emotion</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>Sentiment</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="recentEntriesTable"></tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <div id="noDataMessage" class="alert alert-info" style="display: none;">
Â  Â  Â  Â  No entries yet â€” start journaling to see trends!
Â  Â  </div>
</div>

<script>
let sentimentChart, emotionChart;

async function loadAnalytics() {
Â  Â  try {
Â  Â  Â  Â  const response = await fetch('/api/analytics');
Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('loadingSpinner').style.display = 'none';
Â  Â  Â  Â  
Â  Â  Â  Â  if (data.empty) {
Â  Â  Â  Â  Â  Â  document.getElementById('noDataMessage').style.display = 'block';
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  document.getElementById('analyticsContent').style.display = 'block';
Â  Â  Â  Â  
Â  Â  Â  Â  // Update metrics
Â  Â  Â  Â  document.getElementById('metricTotal').textContent = data.metrics.total;
Â  Â  Â  Â  document.getElementById('metricAvg').textContent = data.metrics.avg_sentiment;
Â  Â  Â  Â  document.getElementById('metricPositive').textContent = data.metrics.positive_pct + '%';
Â  Â  Â  Â  document.getElementById('metricSpan').textContent = data.metrics.days_span + ' days';
Â  Â  Â  Â  
Â  Â  Â  Â  // Sentiment over time chart
Â  Â  Â  Â  const sentimentDates = data.sentiment_data.map(d => new Date(d.timestamp).toLocaleDateString());
Â  Â  Â  Â  const sentimentValues = data.sentiment_data.map(d => d.sentiment);
Â  Â  Â  Â  
Â  Â  Â  Â  const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
Â  Â  Â  Â  sentimentChart = new Chart(sentimentCtx, {
Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: sentimentDates,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Sentiment',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: sentimentValues,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX 1: Check if context.parsed exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = context.parsed ? context.parsed.y : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return value >= 0.5 ? '#22C55E' : value > 0 ? '#F59E0B' : '#EF4444';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(124, 58, 237, 0.1)',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tension: 0.4,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointRadius: 5,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointBackgroundColor: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX 2: Check if context.parsed exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = context.parsed ? context.parsed.y : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return value >= 0.5 ? '#22C55E' : value > 0 ? '#F59E0B' : '#EF4444';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  segment: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: function(context) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX 3: Check if context.p1 AND parsed data exists
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = context.p1 && context.p1.parsed ? context.p1.parsed.y : 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return value >= 0.5 ? '#22C55E' : value > 0 ? '#F59E0B' : '#EF4444';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min: -1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  max: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#E5E7EB' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(229, 231, 235, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#E5E7EB' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(229, 231, 235, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Emotion distribution chart
Â  Â  Â  Â  const emotionLabels = Object.keys(data.emotion_counts);
Â  Â  Â  Â  const emotionValues = Object.values(data.emotion_counts);
Â  Â  Â  Â  
Â  Â  Â  Â  const emotionCtx = document.getElementById('emotionChart').getContext('2d');
Â  Â  Â  Â  emotionChart = new Chart(emotionCtx, {
Â  Â  Â  Â  Â  Â  type: 'bar',
Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  labels: emotionLabels,
Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  label: 'Count',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: emotionValues,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: '#7C3AED',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#8B5CF6',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 1
Â  Â  Â  Â  Â  Â  Â  Â  }]
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  indexAxis: 'y',
Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false,
Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: { display: false }
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  scales: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  x: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#E5E7EB' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { color: 'rgba(229, 231, 235, 0.1)' }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ticks: { color: '#E5E7EB' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grid: { display: false }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  Â  Â  // Recent entries table
Â  Â  Â  Â  const tableBody = document.getElementById('recentEntriesTable');
Â  Â  Â  Â  data.recent_entries.forEach(entry => {
Â  Â  Â  Â  Â  Â  const date = new Date(entry.timestamp).toLocaleDateString();
Â  Â  Â  Â  Â  Â  tableBody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${date}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.emotion}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.sentiment.toFixed(2)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${entry.summary || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  });
Â  Â  Â  Â  
Â  Â  } catch (error) {
Â  Â  Â  Â  document.getElementById('loadingSpinner').style.display = 'none';
Â  Â  Â  Â  // Log error to console for better debugging, keep alert simple
Â  Â  Â  Â  console.error('Error in loadAnalytics:', error);
Â  Â  Â  Â  alert('Error loading analytics: ' + error.message);
Â  Â  }
}

window.addEventListener('load', loadAnalytics);
</script>

<style>
.table-dark {
    background-color: var(--bg-container);
    color: var(--text-primary);
}
.table-dark th {
    background-color: var(--bg-secondary);
    border-color: var(--border);
}
.table-dark td {
    border-color: var(--border);
}
.table-hover tbody tr:hover {
    background-color: rgba(124, 58, 237, 0.1);
}
</style>
{% endblock %}
